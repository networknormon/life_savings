<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Colecciones & Finanzas</title>
    <link rel="stylesheet" href="style.css">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script>
        window.isShowcase = new URLSearchParams(window.location.search).has('share');

        if (!window.isShowcase) {
            const hash = window.location.hash;
            let idToken = localStorage.getItem('cognito_id_token');
            if (hash.includes("id_token=")) {
                const urlParamsHash = new URLSearchParams(hash.replace('#', '?'));
                idToken = urlParamsHash.get('id_token');
                localStorage.setItem('cognito_id_token', idToken);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            if (!idToken) {
                window.location.href = 'https://networknormon.github.io/life_savings/login.html';
            }
        }
        
        function logout() {
            localStorage.removeItem('cognito_id_token');
            window.location.href = 'https://networknormon.github.io/life_savings/login.html';
        }
    </script>
</head>
<body>

    <header>
        <div class="container header-content">
            <div class="logo">
                <button id="hamburger-btn" class="hamburger-btn" onclick="toggleMenu()">‚ò∞</button>
                <span class="icon">üìö</span>
                <h1 id="main-title">Gestor</h1>
            </div>
            <div class="badges" id="header-badges">
                <span class="badge warning" id="global-missing-count" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">Calculando...</span>
            </div>
        </div>
    </header>

    <div class="side-menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="side-menu">
        <div class="menu-header">
            <h2 style="color: white; font-size: 1.2rem; margin: 0;">‚öôÔ∏è Opciones</h2>
            <button class="hamburger-btn" onclick="toggleMenu()">‚úï</button>
        </div>
        
        <button onclick="requestNotifications(); toggleMenu();" class="btn" style="border-color: #f59e0b; color: #f59e0b; text-align: left; padding: 0.8rem;">üîî Notificaciones</button>
        <button onclick="openTrophies(); toggleMenu();" class="btn" style="border-color: #eab308; color: #eab308; text-align: left; padding: 0.8rem;">üèÜ Mis Trofeos</button>
        <button onclick="shareShowcase(); toggleMenu();" class="btn" style="border-color: #3b82f6; color: #3b82f6; text-align: left; padding: 0.8rem;">üîó Compartir Vitrina</button>
        <button onclick="openScanner(); toggleMenu();" class="btn" style="border-color: var(--success); color: var(--success); text-align: left; padding: 0.8rem;">üì∑ Escanear Manga</button>
        <button onclick="logout()" class="btn" style="border-color: var(--danger); color: var(--danger); text-align: left; padding: 0.8rem; margin-top: auto;">üö™ Cerrar Sesi√≥n</button>
    </div>

    <main class="container">
        
        <section class="finance-panel" id="finance-section">
            
            <div style="display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); padding: 1rem; border-radius: 1rem; border: 1px solid #334155;">
                <h2 style="font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">üìÖ Finanzas</h2>
                <input type="month" id="month-selector" onchange="changeMonth(this.value)" class="btn" style="background: #0f172a; color: white; border: 1px solid #334155; padding: 0.5rem;">
            </div>

            <div class="inputs-grid">
                
                <div class="card input-card">
                    <label>Ingresos Mensuales</label>
                    <div class="input-wrapper">
                        <span>‚Ç¨</span>
                        <input type="number" id="salary" onchange="updateSalary(this.value)">
                    </div>
                </div>

                <div class="card input-card" style="display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="margin:0;">Gastos Fijos</label>
                        <button class="btn" onclick="togglePanel('fixed-panel')" style="padding: 0.1rem 0.5rem; font-size: 0.7rem;">Editar ‚ñº</button>
                    </div>
                    <div class="input-wrapper minus">
                        <span>‚Ç¨</span>
                        <span id="total-fixed-display" style="font-size: 1.5rem; font-weight: 700; color: white;">0.00</span>
                    </div>
                    
                    <div id="fixed-panel" class="smooth-panel">
                        <div class="smooth-panel-inner">
                            <div id="fixed-list" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.75rem; max-height: 150px; overflow-y: auto;"></div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="new-fixed-name" placeholder="Ej. Internet" style="flex: 1; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 4px; padding: 0.5rem; font-size: 0.85rem; outline: none;">
                                    <input type="number" id="new-fixed-amount" placeholder="‚Ç¨" style="width: 80px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 4px; padding: 0.5rem; font-size: 0.85rem; outline: none;">
                                </div>
                                <button class="btn btn-primary" onclick="addExpense('fixed')" style="width: 100%; padding: 0.5rem; border-radius: 4px; font-weight: bold;">+ A√±adir Fijo</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card input-card" style="display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="margin:0;">Gastos Variables</label>
                        <button class="btn" onclick="togglePanel('variable-panel')" style="padding: 0.1rem 0.5rem; font-size: 0.7rem;">Editar ‚ñº</button>
                    </div>
                    <div class="input-wrapper minus">
                        <span>‚Ç¨</span>
                        <span id="total-variable-display" style="font-size: 1.5rem; font-weight: 700; color: white;">0.00</span>
                    </div>
                    
                    <div id="variable-panel" class="smooth-panel">
                        <div class="smooth-panel-inner">
                            <div id="variable-list" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.75rem; max-height: 150px; overflow-y: auto;"></div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <select id="new-variable-tag" style="background: #0f172a; color: white; border: 1px solid #334155; border-radius: 4px; padding: 0.5rem; font-size: 0.85rem; outline: none;">
                                        <option value="üçî">üçî Comida</option>
                                        <option value="üöó">üöó Transp.</option>
                                        <option value="üçª">üçª Ocio</option>
                                        <option value="üõí">üõí Compras</option>
                                        <option value="üí°">üí° Hogar</option>
                                        <option value="‚ùì">‚ùì Otros</option>
                                    </select>
                                    <input type="number" id="new-variable-amount" placeholder="‚Ç¨" style="width: 80px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 4px; padding: 0.5rem; font-size: 0.85rem; outline: none;">
                                </div>
                                <input type="text" id="new-variable-name" placeholder="Descripci√≥n (Ej. Cine)" style="width: 100%; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 4px; padding: 0.5rem; font-size: 0.85rem; outline: none;">
                                <button class="btn btn-primary" onclick="addExpense('variable')" style="width: 100%; padding: 0.5rem; border-radius: 4px; font-weight: bold;">+ A√±adir Variable</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card slider-card">
                    <div class="slider-header">
                        <label>Inversi√≥n Mensual</label>
                        <span id="allocation-display">30%</span>
                    </div>
                    <input type="range" id="allocation" min="0" max="100" value="30" onchange="updateAllocation(this.value)">
                    <div class="slider-footer">
                        Disponible: <span id="hobby-budget">‚Ç¨0.00</span>
                    </div>
                </div>
            </div>

            <div class="strategy-box">
                <div class="strategy-icon">üê∑</div>
                <div class="strategy-text">
                    <h3>Plan de Ataque</h3>
                    <p>
                        Para el Master Set de Magic (<span id="magic-cost">‚Ç¨0</span>), guarda 
                        <strong class="text-green" id="savings-suggestion">‚Ç¨0</strong> en la hucha.
                        Usa los <strong class="text-blue" id="spending-money">‚Ç¨0</strong> restantes para mangas sueltos.
                    </p>
                    <div class="strategy-time">Tiempo estimado: <span id="months-to-finish">--</span> Meses</div>
                </div>
            </div>
        </section>

        <div id="collections-container" class="collections-grid"></div>
        
        <div id="create-collection-container" style="text-align: center; margin-top: 2rem; margin-bottom: 2rem;">
            <button onclick="openCollectionModal()" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1.1rem; border-radius: 999px; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);">
                ‚ûï Crear Nueva Colecci√≥n
            </button>
        </div>

    </main>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1408.0.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script> 
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
            });
        }
    </script>
    
    <script src="script.js"></script>
</body>
</html>